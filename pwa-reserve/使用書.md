# TERACO予約システム 使用書

本ドキュメントは、TERACO予約システムの運用で使用する情報を記録した使用書です。

---

## 1. 本番で使用しているURL

### フロント（PWA）
- **公開URL**: https://anomalocaress.github.io/teraco-labo-website-v2/pwa-reserve/

### バックエンド（GAS ウェブアプリ）
- **API エンドポイント（本番）**:  
  `https://script.google.com/macros/s/AKfycbwzRh2WYpVdahLQMunFywTDARr5iODNGKNp_4YXS_M-adSLI81IZwjvVeBbsX9IWRH9/exec`

※ フロントの `main.js` の `API_BASE` は上記URLを参照しています。GASを再デプロイしてURLが変わった場合は、`main.js` の1行目と本使用書を更新してください。

---

## 2. バックエンドのバージョンと主な仕様（v43）

- **現在のGASバージョン**: v43（予約確認・キャンセル表示の修正版）

### 予約まわり
- **複数予約**: 一度に複数枠を予約可能。各枠ごとにイベントを作成または既存イベントに名前を追加。
- **Googleカレンダーへの反映**:
  - 予約者を「回答待ち（needsAction）」でサイレント追加（招待メールは送らない）。
  - 主催者（教室側）を attendees に含めることで、カレンダー上で「全員がこの予定への参加を辞退しました」と誤表示されないようにしている。
  - 複数件予約時は、APIの連続呼び出しを避けるため、2件目以降のゲスト追加前に短い待機を入れ、失敗時は1回リトライする。
- **反映件数の表示**: カレンダー反映が一部のみだった場合、「○件予約しました（Googleカレンダー反映: ○/○件）」と表示する。

### 取り消しまわり
- **取り消し**: 選択した予約をまとめて取り消し可能。予約した数と同じ数だけ event_id を送ることで、同じ数だけ確実に削除・ゲスト削除される。
- **カレンダーからの消去**: 生徒のGoogleカレンダーからも予定を消すため、`sendUpdates: 'all'` でGoogle側にキャンセル通知を送信している。
- **締切**: 当日および「前日17:00」を過ぎたキャンセルはバックエンドで拒否。

### 予約・キャンセルの締切
- 予約: 明日以降の枠のみ。明日の枠は「本日17:00」まで受付。
- キャンセル: 明日以降の予約のみ。明日の予約は「本日17:00」まで受付。当日・締切後は教室へ直接連絡。

---

## 3. 管理者向け

### 管理者ダッシュボード
- **入口**: 予約ページ最下部の「管理者の方はこちら」リンク。
- **パスコード**: `2684`（`Code.gs` の `ADMIN_PASSCODE` で変更可能）。
- **表示内容**: 「今日」「明日」の各時間枠の予約者名一覧。

### 主な設定（Code.gs の CONFIG）
- `TEACHER_EMAIL`: 管理者（講師）への通知先メールアドレス。
- `CALENDAR_ID`: 予約に使うGoogleカレンダー（通常は `'primary'`）。
- `ADMIN_PASSCODE`: 管理者画面のパスコード。

---

## 4. 運用・トラブル時の参照

- **デプロイ・テスト手順**: `DEPLOYMENT_CHECKLIST.md`
- **GASの編集・デプロイ手順**: `gas/README.md`
- **仕様・開発履歴**: リポジトリルートの `PROJECT_SPEC.md`

---

## 5. 更新履歴（使用書）

| 日付       | 内容 |
|------------|------|
| 2026-01-29 | 初版作成。本番GAS URL・v41の仕様（複数予約・カレンダー反映・取り消し・管理者）を記載。 |
| 2026-02-05 | v43: 予約確認・キャンセルで「予定が見つからない」問題を修正。overview取得をGET→POSTに変更（クエリパラメータ消失を回避）。 |
