<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TERACO予約</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#00c853">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root {
      --green: #06C755;
      --green-deep: #039744;
      --green-weak: #e2fbe7;
      --border: #e5f5e8;
      --bg: #f8fdf8;
      --text: #222;
      --muted: #555;
      --error: #d32f2f;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #fff;
      color: var(--text);
      font-size: 20px;
      line-height: 1.7;
    }

    header {
      position: sticky;
      top: 0;
      padding: 20px 20px;
      background: var(--green);
      color: #fff;
      font-size: 28px;
      font-weight: 700;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .wrap {
      max-width: 860px;
      margin: 0 auto;
      padding: 24px 20px 60px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Common Panel Styles */
    .panel {
      border: 2px solid var(--border);
      border-radius: 20px;
      padding: 20px;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    }

    .panel h2 {
      margin: 0 0 20px;
      color: var(--green-deep);
      font-size: 26px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel h2 .step-badge {
      background: var(--green);
      color: #fff;
      font-size: 14px;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 700;
    }

    .panel.hidden {
      display: none;
    }

    .hidden {
      display: none !important;
    }

    /* Notice */
    .notice {
      font-size: 17px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 16px;
    }

    /* Calendar */
    .calendar-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    .calendar {
      flex: 1 1 300px;
      border: 2px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      background: #fff;
    }

    .calendar header {
      position: static;
      background: var(--bg);
      color: var(--green-deep);
      font-size: 20px;
      font-weight: 700;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    table.month-grid {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    table.month-grid th {
      padding: 10px 0;
      background: #f5faf6;
      color: var(--muted);
      font-weight: 600;
      border-bottom: 1px solid var(--border);
    }

    table.month-grid td {
      height: 64px;
      text-align: center;
      vertical-align: middle;
      border-bottom: 1px solid var(--border);
      border-right: 1px solid var(--border);
      cursor: pointer;
      position: relative;
      font-size: 20px;
      font-weight: 600;
    }

    table.month-grid td:last-child {
      border-right: none;
    }

    td.disabled {
      color: #ccc;
      background: #fafafa;
      cursor: default;
    }

    td.active {
      background: var(--green);
      color: #fff !important;
      font-weight: 700;
    }

    td.has-reservation::after {
      content: '●';
      position: absolute;
      bottom: 4px;
      right: 50%;
      transform: translateX(50%);
      font-size: 10px;
      color: var(--green-deep);
    }

    td.active.has-reservation::after {
      color: #fff;
    }

    td.has-selected {
      background: var(--green-weak);
      color: var(--green-deep);
      font-weight: 700;
      border: 2px solid var(--green);
    }

    td.full {
      color: #ccc;
      background: #fff0f0;
    }

    /* Time Selection (Dropdown) */
    .time-select-wrapper {
      margin-top: 20px;
      padding: 20px;
      background: var(--bg);
      border-radius: 16px;
      border: 2px solid var(--green);
    }

    .time-select-label {
      display: block;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--green-deep);
      font-size: 20px;
    }

    select.large-select {
      width: 100%;
      font-size: 22px;
      padding: 16px;
      border-radius: 12px;
      border: 2px solid #ccc;
      background: #fff;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 16px top 50%;
      background-size: 16px auto;
    }

    select.large-select:focus {
      outline: none;
      border-color: var(--green);
      box-shadow: 0 0 0 4px rgba(6, 199, 85, 0.2);
    }

    /* Selected Items */
    .selected-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 2px solid var(--green);
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      font-size: 18px;
    }

    /* Input Field */
    label.field {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 18px;
      font-weight: 700;
    }

    input[type="text"] {
      font-size: 24px;
      padding: 20px 16px;
      border: 3px solid #ccc;
      border-radius: 12px;
      width: 100%;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--green);
      box-shadow: 0 0 0 4px rgba(6, 199, 85, 0.2);
    }

    /* Refresh Icon Button */
    .refresh-icon {
      z-index: 10;
    }

    .refresh-icon:hover {
      opacity: 1 !important;
      color: var(--green) !important;
    }

    .refresh-icon:active {
      transform: rotate(180deg);
      transition: transform 0.3s;
    }

    /* Buttons */
    .actions {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 20px;
    }

    button.big {
      font-size: 22px;
      padding: 24px;
      border-radius: 16px;
      border: 0;
      background: var(--green);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      box-shadow: 0 5px 0 var(--green-deep);
      transition: transform 0.1s;
    }

    button.big:active {
      transform: translateY(4px);
      box-shadow: none;
    }

    button.big:disabled {
      background: #ccc;
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
    }

    button.soft {
      background: #fff;
      color: var(--muted);
      border: 2px solid #ccc;
      padding: 18px;
      font-size: 20px;
      border-radius: 12px;
      cursor: pointer;
    }

    .hint {
      font-size: 15px;
      color: var(--muted);
      margin-top: 6px;
    }

    .error-msg {
      color: var(--error);
      font-weight: 700;
      margin-top: 8px;
      display: none;
    }

    /* Inline Time Select */
    .inline-time-select {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      font-size: 16px;
      opacity: 0;
      /* Invisible overlay */
      cursor: pointer;
      z-index: 10;
      appearance: none;
      /* Remove default arrow */
    }

    /* Toggle Buttons for Class Selection */
    .selection-group {
      margin-bottom: 16px;
    }

    .field-label {
      display: block;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text);
    }

    .toggle-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .toggle-btn {
      flex: 1;
      padding: 18px 12px;
      border: 2px solid #ddd;
      background: #fff;
      color: var(--text);
      border-radius: 12px;
      font-size: 20px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      min-width: 120px;
    }

    .toggle-btn.active {
      border-color: var(--green);
      background: var(--green);
      color: #fff;
    }

    /* Time Panel (below calendar) */
    #timePanelWrap {
      margin-top: 20px;
      background: var(--bg);
      border: 3px solid var(--green);
      border-radius: 20px;
      padding: 20px;
    }

    .time-btn-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 16px;
    }

    .time-btn {
      padding: 24px 10px;
      border: 3px solid var(--green);
      background: #fff;
      border-radius: 14px;
      font-size: 26px;
      font-weight: 700;
      cursor: pointer;
      color: var(--green-deep);
      transition: all 0.15s;
      text-align: center;
      white-space: pre-line;
      line-height: 1.4;
    }

    .time-btn:active:not(:disabled) {
      background: var(--green);
      color: #fff;
      transform: translateY(2px);
    }

    .time-btn-selected {
      background: var(--green) !important;
      color: #fff !important;
      border-color: var(--green-deep) !important;
    }

    .time-btn-full, .time-btn-done {
      border-color: #ddd !important;
      color: #bbb !important;
      background: #f5f5f5 !important;
      cursor: not-allowed;
      font-weight: 400;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width:640px) {
      .wrap {
        padding: 16px;
      }

      table.month-grid td {
        height: 48px;
        font-size: 16px;
      }

      .calendar {
        flex: 1 1 100%;
      }

      .toggle-btn {
        font-size: 14px;
        padding: 10px;
      }
    }

    /* Loading Overlay */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      font-weight: bold;
      color: var(--green-deep);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    #loadingOverlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--border);
      border-top: 5px solid var(--green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Admin Dashboard */
    .admin-day-group {
      margin-bottom: 24px;
      border: 1px solid #ddd;
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
    }
    .admin-day-label {
      background: #f0f0f0;
      padding: 10px 16px;
      font-weight: bold;
      border-bottom: 1px solid #ddd;
      color: #333;
    }
    .admin-slot-item {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
    }
    .admin-slot-item:last-child {
      border-bottom: none;
    }
    .admin-slot-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .admin-slot-time {
      font-weight: bold;
      color: var(--green-deep);
      font-size: 1.1em;
    }
    .admin-slot-count {
      font-size: 13px;
      background: #f5f5f5;
      color: #666;
      padding: 2px 10px;
      border-radius: 20px;
      border: 1px solid #ddd;
    }
    .admin-names-list {
      font-size: 15px;
      color: #444;
      padding: 8px;
      background: #f9fdfa;
      border-radius: 8px;
      margin-top: 4px;
      white-space: pre-wrap;
      line-height: 1.4;
    }
    .admin-empty-msg {
      font-size: 14px;
      color: #999;
      font-style: italic;
    }
  </style>
</head>

<body>
  <header>TERACO予約</header>
  <div class="wrap">

    <div class="notice" style="font-size:20px;">
      <strong>予約の手順</strong><br><br>
      ① お名前を入力してください<br>
      ② クラスを選んでください<br>
      ③ 日付と時間をタップしてください<br>
      ④「予約を確定する」を押してください
    </div>

    <div class="panels">

      <!-- STEP 1: Name & Class Selection -->
      <div id="namePanel" class="panel">
        <h2><span class="step-badge">STEP 1</span> お名前とクラス</h2>
        <div id="inputSection">
          <div class="input-group" style="position: relative;">
            <label style="font-size:20px; font-weight:700; display:block; margin-bottom:10px;">お名前（フルネーム）</label>
            <button id="btnRefresh" class="refresh-icon" title="リフレッシュ（名前と予約をリセット）" style="position: absolute; top: 0; right: 0; background: none; border: none; cursor: pointer; padding: 4px; font-size: 20px; color: #666; opacity: 0.7; transition: opacity 0.2s;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                <path d="M21 3v5h-5"></path>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                <path d="M3 21v-5h5"></path>
              </svg>
            </button>
            <input type="text" id="nameInput" placeholder="例：田中花子" />
            <div class="hint" style="font-size:17px; margin-top:8px;">※ 姓と名はスペースなしで入力してください</div>
            <div class="error-msg" id="nameError">お名前を入力してください</div>

            <div style="text-align:center; margin: 16px 0 8px; font-size:12px; color:#666;">または Googleアカウントで自動入力</div>

            <div id="googleBtnWrapper" style="margin-bottom: 12px;">
              <!-- Google Sign-In Button Container -->
              <div id="g_id_onload"
                data-client_id="962051135287-af9qpio58l2qt7cu3avip6qvk9269sl2.apps.googleusercontent.com"
                data-callback="handleCredentialResponse" data-auto_prompt="true" data-auto_select="true"
                data-itp_support="true">
              </div>
              <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline"
                data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left">
              </div>
            </div>

            <!-- Calendar Invite Option -->
            <div id="calendarOption" style="margin-top: 12px; display: none;">
              <label style="display: flex; align-items: center; cursor: pointer; font-size: 14px;">
                <input type="checkbox" id="addToCalendar" style="transform: scale(1.2); margin-right: 8px;">
                Googleカレンダーに追加する
              </label>
            </div>
          </div>

          <!-- Class Selection -->
          <div class="class-selection" style="margin-top: 32px; border-top: 2px solid #eee; padding-top: 28px;">

            <!-- Category -->
            <div class="selection-group">
              <label class="field-label" style="font-size:20px; font-weight:700; margin-bottom:12px; display:block;">コース種別</label>
              <div class="toggle-group" id="categoryGroup">
                <button type="button" class="toggle-btn active" data-value="smartphone">スマホ</button>
                <button type="button" class="toggle-btn" data-value="pc_ai">パソコンAI</button>
              </div>
            </div>

            <!-- Course (Dynamic) -->
            <div class="selection-group" style="margin-top:20px;">
              <label class="field-label" style="font-size:20px; font-weight:700; margin-bottom:12px; display:block;">クラス</label>
              <!-- Smartphone Options -->
              <div id="courseSmartphone" class="toggle-group" style="flex-direction:column;">
                <button type="button" class="toggle-btn active" data-value="intro">入門まなび（45分）</button>
                <button type="button" class="toggle-btn" data-value="applied">応用てらこ（90分）</button>
                <button type="button" class="toggle-btn" data-value="private">個人レッスン（50分）</button>
              </div>
              <!-- PC/AI Options (Hidden initially) -->
              <div id="coursePcAi" class="toggle-group hidden" style="flex-direction:column;">
                <button type="button" class="toggle-btn active" data-value="basic">基礎ベーシック（45分）</button>
                <button type="button" class="toggle-btn" data-value="advance">実践アドバンス（90分）</button>
                <button type="button" class="toggle-btn" data-value="private">個人レッスン（50分）</button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- STEP 2: Date & Time -->
      <div id="calendarPanel" class="panel">
        <h2><span class="step-badge">STEP 2</span> 日付と時間を選ぶ</h2>
        <div style="font-size:19px; color:var(--muted); margin-bottom:20px;">日付をタップすると時間ボタンが出ます</div>

        <div id="current-date-display" style="text-align:center; margin-bottom:16px; font-size: 18px; color: var(--muted);"></div>

        <div id="calendarWrap" class="calendar-wrap"></div>

        <div id="timePanelWrap" class="hidden"></div>

        <div id="timeSelectContainer" class="hidden" style="display:none;"></div>
      </div>

      <!-- STEP 3: Confirmation -->
      <div id="confirmPanel" class="panel">
        <h2><span class="step-badge">STEP 3</span> 予約内容の確認</h2>

        <div id="selectedList">
          <div class="hint">まだ日時が選択されていません。</div>
        </div>

        <div class="actions">
          <button id="btnClear" class="soft">選択をクリア</button>
          <button id="btnSubmit" class="big" disabled>予約を確定する</button>
        </div>
      </div>

      <!-- STEP 4: Check & Cancel Reservations -->
      <div id="managePanel" class="panel" style="margin-top: 40px; border-top: 4px solid var(--green);">
        <h2>予約の確認・取り消し</h2>
        <p style="margin-bottom:20px; font-size:19px;">
          予約を確認したり、取り消したりできます。</p>

        <div style="text-align:center; margin-bottom:24px;">
          <button id="btnCheckReservation" class="soft"
            style="width:100%; padding:22px; font-size:22px; font-weight:bold;">
            予約を確認する
          </button>
        </div>

        <div id="existingPanel" class="hidden">
          <h3>あなたの予約状況</h3>
          <div id="existingList"></div>
          <div style="margin-top:16px; text-align:right;">
            <button id="btnCancelSelected" class="soft"
              style="color:var(--error); border-color:var(--error);">選択した予約を取り消す</button>
          </div>
        </div>
      </div>

      <!-- Admin Dashboard Panel -->
      <div id="adminPanel" class="panel hidden" style="margin-top: 60px; border-top: 4px solid #333; background: #fafafa;">
        <h2 style="color:#333;"><span class="step-badge" style="background:#333;">管理</span> 管理者メニュー</h2>
        
        <div id="adminLoginView">
          <p style="font-size:14px; color:#666; margin-bottom:12px;">パスコードを入力してログインしてください。</p>
          <input type="password" id="adminPasscode" placeholder="****" 
            style="text-align:center; letter-spacing: 0.5em; font-size: 24px; padding: 12px; border: 2px solid #333; width: 100%;">
          <button id="btnAdminLogin" class="big" style="margin-top:16px; background:#333; box-shadow: 0 4px 0 #000;">ログイン</button>
        </div>

        <div id="adminContentView" class="hidden">
          <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 id="adminSummaryTitle" style="margin:0; font-size:18px;">予約状況（今日・明日）</h3>
            <button id="btnAdminRefresh" class="soft" style="padding: 8px 16px; font-size: 14px;">更新</button>
          </div>
          <div id="adminSummaryList"></div>
          <button id="btnAdminLogout" class="soft" style="width:100%; margin-top:24px; border-color:#999;">ログアウト</button>
        </div>
      </div>

      <!-- Hidden Admin Trigger -->
      <div style="text-align:center; margin-top:40px; padding-bottom: 20px;">
        <span id="adminTrigger" style="font-size:12px; color:#ccc; cursor:pointer; text-decoration: underline;">管理者の方はこちら</span>
      </div>

    </div>

    <div id="message" class="message" style="text-align:center;font-weight:700;color:var(--green);"></div>
  </div>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText">処理中です...</div>
  </div>
  <script src="main.js?v=43.2"></script>
  <script>if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }</script>
</body>

</html>