# TERACO予約システム 作業履歴

## 📅 2026-01-29 作業内容

### 1. 予約表示問題の改善（完了）
- **症状**: 既存ユーザーが「予約を確認する」を押しても情報が表示されない。
- **原因**: 
  - フロントエンドが `ev.iso` を参照していたが、バックエンドは `ev.start` を返していた。
  - サーバーから取得した最新の予約状況（人数など）が `state.slots` に再反映されていなかった。
- **対策**:
  - `pwa-reserve/main.js` の `loadOverview` 内でプロパティ名を `ev.start` に統一。
  - サーバーレスポンス受領時に最新の状態に更新するよう修正。

### 2. 予約人数のカウントロジック修正（完了）
- **内容**: 
  - 1つのイベントに複数人が予約している場合、イベント数ではなく「説明欄の名前の行数」をカウントするように `pwa-reserve/gas/Code.gs` を修正。

### 3. メール通知機能の強化と安定化（完了）
- **管理者通知**: 新規予約・取消のすべてを `CONFIG.TEACHER_EMAIL` 宛に送信。ログインユーザーの場合はそのメールアドレスも本文に記載。
- **ユーザー通知**: Googleログイン済みユーザーにのみ、詳細な予約完了・取消メールを送信。
- **安定化**: 
  - メールの差出人名称を設定。
  - エラーハンドリングを追加し、送信失敗時にログを残すよう改善。

### 5. Googleカレンダー連携の自動化とノイズ削減（完了）
- **自動承諾**: ユーザーがカレンダー追加を選択した際、招待メールを送らず、かつ最初からステータスを「出席（承諾済み）」にセット。
- **通知抑制**: ユーザーが「はい」を押す手間を省き、管理者への「出席の回答」メール通知を完全にブロック。
- **UI調整**: ユーザーに不要な不安を与えないよう「招待メールが届きます」という文言を削除。

### 6. キャンセル時の生徒カレンダー完全消去（完了）
- **症状**: 管理者カレンダーからは消えるが、生徒側のカレンダーに予定が残ってしまう。
- **対策**: ゲスト削除前に明示的に `declined`（辞退）ステータスをセットする 2-Step 削除ロジックを実装。これにより、生徒側のカレンダーからも即座に予定が消去されるように改善。

### 7. サイレント制御の徹底（完了）
- **ステータス管理**: ゲストを完全に削除するのではなく「辞退(declined)」にセットし、`sendUpdates: 'none'` でサイレント更新。これにより、生徒側のカレンダーから予定が消え、かつ手動削除による通知メールも発生しないように改善。
- **完全消去**: 予約者ゼロ時のイベント削除も API 経由で `sendUpdates: 'none'` 指定を試みたが、Googleの仕様制限により確実な消去には通知が必要と判明。

### 8. キャンセル通知の戦略的活用 (v36 採用)
- **新仕様**: 生徒さんのカレンダーから予定を確実に消去するため、キャンセル時のみ `sendUpdates: 'all'`（通知あり）を許容する仕様に変更。
- **効果**: 生徒さんにキャンセルメールが届くと同時に、カレンダーから予定が自動削除される。

### 9. ステータス管理の適正化とカレンダー同期の完成 (v37 採用)
- **予約ステータスの修正**: 予約時に「出席」を強制せず、デフォルトの「回答待ち」状態で登録。これにより、Googleのセキュリティ制限による「自動辞退（不参加）」扱いを防ぎ、スマホ上で「全員が辞退しました」という誤った警告が出る問題を解消。
- **削除ロジックの確定**: キャンセル時は引き続き「通知あり」でゲスト削除を実行。これにより、生徒さんのカレンダーから確実に予定が消去される挙動を担保。

### 10. バックエンド締切チェックとユーザー通知の親切化 (v38 採用)
- **締切厳格化**: フロントエンドに加えて、バックエンド (`Code.gs`) でも「前日17:00」を過ぎた予約・取消を拒否するロジックを実装。
- **エラーメッセージ改善**: 通信エラーやGASの初回起動遅延（スリープ）時に、ユーザーが「壊れている」と誤解しないよう、日本語で丁寧な案内を出すように修正。

### 11. 管理者ダッシュボードの実装 (v39 採用)
- **新機能**: アプリ上で「今日・明日」の予約者一覧をサッと確認できる管理者専用画面を実装。
- **セキュリティ**: 簡易パスコード認証（初期設定 `1234`）を導入。
- **アクセシビリティ**: ページ最下部の隠しリンクからアクセス可能。カレンダーを開く手間を大幅に削減。

---

## 🛠 現在の構成
- **Frontend**: GitHub Pages (`pwa-reserve/main.js`, `pwa-reserve/index.html`) - API v39 連携済み
- **Backend**: Google Apps Script (v39 管理者ダッシュボード対応版)
- **Database**: Google Calendar
