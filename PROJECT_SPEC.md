# TERACO予約システム プロジェクト仕様書

本ドキュメントは、TERACO予約システムの仕様、現在の開発状況、および今後のロードマップを記録し、ユーザーとAIの間で共有するためのものです。

---

## 1. システム概要
- **名称**: TERACO予約システム (PWA)
- **目的**: スマホ教室TERACOの講座予約・管理を効率化し、生徒と管理者の手間を最小限にする。
- **公開URL**: [https://anomalocaress.github.io/teraco-labo-website-v2/pwa-reserve/](https://anomalocaress.github.io/teraco-labo-website-v2/pwa-reserve/)

---

## 2. 技術アーキテクチャ
- **Frontend**: HTML5 / CSS3 / JavaScript (Vanilla JS)
  - GitHub Pagesによるホスティング。
  - PWA対応（サービスワーカーによるオフライン対応）。
- **Backend**: Google Apps Script (GAS)
  - Web APIとしてデプロイ。
- **Database**: Google Calendar
  - 予約枠の管理、生徒へのカレンダー同期。
- **認証**: Google Identity Services (Googleログイン)
  - 名前入力の自動化および個人カレンダー連携。

---

## 3. 現在の主要仕様 (v37)

### A. 予約フロー
1.  **名前入力**: 手動入力、またはGoogleログインによる自動取得。
2.  **クラス選択**: コース種別（スマホ/PC・AI）、クラス、回数を選択。
3.  **カレンダー同期**: 
    - Googleログイン済みの場合はデフォルトで「カレンダーに追加」がON。
    - 予約確定時、生徒のカレンダーには「回答待ち（needsAction）」状態でサイレント追加される（招待メールは飛ばない）。
    - 生徒のカレンダーには予定が入り、スマホ上で「辞退」などの誤警告は出ない。

### B. キャンセルフロー
1.  **取消実行**: アプリ下部の管理パネルから実行。
2.  **カレンダー同期**: 
    - 確実に生徒のカレンダーから予定を消去するため、Googleから「キャンセル通知メール」を1通送信する仕様を採用。
    - これにより、Googleの同期信号が生徒側に届き、カレンダーから予定が自動削除される。
3.  **管理者通知**: アプリ独自の「取消通知メール」が送信される。Googleからの返信メール等のノイズは最小限に制御。

### C. 管理ロジック
- **人数カウント**: カレンダーイベントの説明欄にある「名前の行数」をカウント（正確な残席管理）。
- **名表記のゆれ吸収**: 名字と名前の間のスペース除去、旧字体（﨑→崎など）の自動変換。

---

## 4. 開発履歴（主なマイルストーン）
- **2026-01-29**: 
  - 予約人数カウントロジックの修正（行数カウント方式）。
  - メール通知の安定化（管理者への詳細通知、ユーザーへの完了メール）。
  - ディレクトリ構造の復元とURLの維持。
  - **v33**: カレンダー自動承諾・通知抑制の実装。
  - **v34-35**: キャンセル時のカレンダー消去の試行錯誤。
  - **v36**: キャンセル時のみ通知をONにする「確実な消去」仕様へ転換。
  - **v37**: 予約時のステータスを「回答待ち」に戻し、スマホ表示の不自然さを解消。

---

## 5. 今後の課題とロードマップ

### 【直近のタスク】
- [ ] v37の挙動確認（ユーザーによる最終テスト予約・キャンセル）。
- [ ] 予期せぬエラー発生時のエラーメッセージの親切化（ユーザー向け）。

### 【中長期的な改善案】
- [ ] **管理者用ダッシュボード**: カレンダーを直接見なくても、当日の予約一覧を一覧表示できる機能。
- [ ] **予約締切の厳格化**: 現在は前日17:00の制限をフロントエンドで行っているが、バックエンド側でもバリデーションを強化。
- [ ] **複数教室対応**: 将来的に教室が増えた場合のCALENDAR_IDの動的切り替え。

---

## 6. 管理用情報
- **現在のGASバージョン**: v37
- **最新API URL**: `https://script.google.com/macros/s/AKfycbxezu-mJEc4UAHhnS3m5wuhQlP8U8MkKPakkPvZiT2KpHN8Ei0wcMv9f6tdGuwjx1u_/exec`
