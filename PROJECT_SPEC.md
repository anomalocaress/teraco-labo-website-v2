# TERACO予約システム プロジェクト仕様書

本ドキュメントは、TERACO予約システムの仕様、現在の開発状況、および今後のロードマップを記録し、ユーザーとAIの間で共有するためのものです。

---

## 1. システム概要
- **名称**: TERACO予約システム (PWA)
- **目的**: スマホ教室TERACOの講座予約・管理を効率化し、生徒と管理者の手間を最小限にする。
- **公開URL**: [https://anomalocaress.github.io/teraco-labo-website-v2/pwa-reserve/](https://anomalocaress.github.io/teraco-labo-website-v2/pwa-reserve/)

---

## 2. 技術アーキテクチャ
- **Frontend**: HTML5 / CSS3 / JavaScript (Vanilla JS)
  - GitHub Pagesによるホスティング。
  - PWA対応（サービスワーカーによるオフライン対応）。
- **Backend**: Google Apps Script (GAS)
  - Web APIとしてデプロイ。
- **Database**: Google Calendar
  - 予約枠の管理、生徒へのカレンダー同期。
- **認証**: Google Identity Services (Googleログイン)
  - 名前入力の自動化および個人カレンダー連携。

---

## 3. 現在の主要仕様 (v40)

### A. 予約フロー
1.  **名前入力**: 手動入力、またはGoogleログインによる自動取得。
2.  **クラス選択**: コース種別（スマホ/PC・AI）、クラス、回数を選択。
3.  **カレンダー同期**: 
    - Googleログイン済みの場合はデフォルトで「カレンダーに追加」がON。
    - 予約確定時、生徒のカレンダーには「回答待ち（needsAction）」状態でサイレント追加。
4.  **予約制限**: バックエンド側でも「前日17:00まで」のルールを厳格にチェック。

### B. キャンセルフロー
1.  **取消実行**: アプリ下部の管理パネルから実行。
2.  **取消制限**: バックエンド側でも「前日17:00まで」のルールを厳格にチェック。
3.  **カレンダー同期 (v40 強化)**: 
    - 確実に生徒のカレンダーから予定を消去するため、Googleから「キャンセル通知メール」を1通送信。
    - **最適化**: 複数人の予約がある場合は「ゲスト削除」、最後の1人の場合は「イベント削除」を使い分け、確実に同期。
    - **重複抑制**: Googleからの通知がある場合、アプリ独自の完了メールは送信せず、メールの総数を最小限に抑制。

### C. 管理者ダッシュボード
1.  **アクセス**: ページ最下部の隠しリンク「管理者の方はこちら」からアクセス。
2.  **認証**: パスコード入力による簡易認証（設定: `2684`）。判定はサーバー側で秘匿。
3.  **機能**: 「今日」と「明日」の予約状況を一覧表示。各枠の予約者氏名を即座に確認可能。

### D. 管理ロジック
- **人数カウント**: カレンダーイベントの説明欄にある「名前の行数」をカウント。
- **名表記のゆれ吸収**: 旧字体の自動変換、スペース除去。
- **親切なエラー通知**: 通信エラー等に対し、生徒さんが困らない日本語メッセージを表示。

---

## 4. 開発履歴（主なマイルストーン）
- **2026-01-29**: 
  - 予約人数カウントロジックの修正。
  - メール通知の安定化。
  - **v33**: カレンダー自動承諾・通知抑制の実装。
  - **v36**: キャンセル通知ONによる「確実な消去」仕様へ。
  - **v37**: 予約時のステータスを「回答待ち」に戻し、スマホ表示を正常化。
  - **v38**: バックエンドでの締切チェック強化。
  - **v39**: 管理者ダッシュボード実装（パスコード `2684`）。
  - **v40**: キャンセル時の通知最適化とカレンダー削除の確実化。

---

## 5. 今後の課題とロードマップ

### 【直近のタスク】
- [ ] v40の挙動確認（キャンセル時のメール通数とカレンダー削除の成否）。

### 【中長期的な改善案】
- [ ] **複数教室対応**: 将来的に教室が増えた場合のCALENDAR_IDの動的切り替え。
- [ ] **管理画面の期間拡大**: 明後日以降の予約状況も確認したい場合の対応。

---

## 6. 管理用情報
- **現在のGASバージョン**: v40
- **最新API URL**: `https://script.google.com/macros/s/AKfycbwjrKVKbw6ohdk58wB7H6vWcB6Rag4UtpX-DQemSiduJ1erm3x-CCgIUTEl7NcThbWU/exec`
